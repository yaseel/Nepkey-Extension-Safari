(function(){"use strict";const c=typeof self<"u"?self:window,l=c.browser??c.chrome;function a(n,e){const t=(o,u,s)=>{if(typeof o=="object"&&o!==null&&o.action===n){const i=e(o,s);if(i instanceof Promise)return i.then(),!0}};return l.runtime.onMessage.addListener(t),()=>l.runtime.onMessage.removeListener(t)}async function p(n,{step:e=30,digits:t=6,algorithm:o="SHA-1",epochMs:u=Date.now()}={}){const s=T(n),i=Math.floor(u/1e3/e),f=await crypto.subtle.importKey("raw",s,{name:"HMAC",hash:o},!1,["sign"]),N=_(i),I=await crypto.subtle.sign("HMAC",f,N);return(d(new Uint8Array(I))%10**t).toString().padStart(t,"0")}function T(n){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",t=n.replace(/=+$/g,"").replace(/\s+/g,"").toUpperCase();let o="";for(const s of t){const i=e.indexOf(s);i!==-1&&(o+=i.toString(2).padStart(5,"0"))}const u=[];for(let s=0;s+8<=o.length;s+=8)u.push(parseInt(o.slice(s,s+8),2));return new Uint8Array(u)}function _(n){const e=new ArrayBuffer(8),t=new DataView(e);for(let o=7;o>=0;o--)t.setUint8(o,n&255),n>>=8;return e}function d(n){const e=n[n.length-1]&15;return(n[e]&127)<<24|(n[e+1]&255)<<16|(n[e+2]&255)<<8|n[e+3]&255}const r={NEPTUN_CODE_INPUT:"#LoginName",NEPTUN_PASSWORD_INPUT:"#Password",NEPTUN_LOGIN_SUBMIT:"input[type=submit]",TOTP_CODE_INPUT:"input[name=TOTPCode]",TOTP_LOGIN_SUBMIT:'button[type="submit"].btn.btn-primary',NEPTUN_SWEB_LINK:'a[href="/ToNeptunWeb/ToNeptunHWeb"]',LOGIN_WITH_NEPTUN_LINK:'a[href="/login/saml"]',IDP_CODE_INPUT:"#username_neptun",IDP_PASSWORD_INPUT:"#password_neptun",IDP_LOGIN_SUBMIT:"input[type=submit]",TMS_CODE_INPUT:'input[name="username"]',TMS_PASSWORD_INPUT:'input[name="password"]',TMS_LOGIN_BUTTON:'button[type="submit"]'};a("neptunLogin",(n,e)=>{const t=document.querySelector(r.NEPTUN_CODE_INPUT),o=document.querySelector(r.NEPTUN_PASSWORD_INPUT),u=document.querySelector(r.NEPTUN_LOGIN_SUBMIT);if(!t||!o||!u){e({ok:!1,message:"Login fields not found."});return}t.value=n.payload.neptunCode,o.value=n.payload.password,t.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("input",{bubbles:!0})),u.click(),e({ok:!0})}),a("neptunTOTP",async(n,e)=>{const t=document.querySelector(r.TOTP_CODE_INPUT),o=document.querySelector(r.TOTP_LOGIN_SUBMIT);if(!t||!o){e({ok:!1,message:"TOTP field not found."});return}t.value=await p(n.payload.otpSecret.trim()),t.dispatchEvent(new Event("input",{bubbles:!0})),o.click(),e({ok:!0})}),a("studentWebClick",(n,e)=>{const t=document.querySelector(r.NEPTUN_SWEB_LINK);if(!t){e({ok:!1,message:"Student Web link not found."});return}t.click(),e({ok:!0})}),a("loginWithNeptun",(n,e)=>{const t=document.querySelector(r.LOGIN_WITH_NEPTUN_LINK);if(!t){e({ok:!1,message:"Login with Neptun link not found."});return}t.click(),e({ok:!0})}),a("idpLogin",(n,e)=>{const t=document.querySelector(r.IDP_CODE_INPUT),o=document.querySelector(r.IDP_PASSWORD_INPUT),u=document.querySelector(r.IDP_LOGIN_SUBMIT);if(!t||!o||!u){e({ok:!1,message:"Login fields not found."});return}t.value=n.payload.neptunCode,o.value=n.payload.password,t.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("input",{bubbles:!0})),u.click(),e({ok:!0})}),a("tmsLogin",(n,e)=>{const t=document.querySelector(r.TMS_CODE_INPUT),o=document.querySelector(r.TMS_PASSWORD_INPUT),u=document.querySelector(r.TMS_LOGIN_BUTTON);if(!t||!o||!u){e({ok:!1,message:"Login fields not found."});return}t.value=n.payload.neptunCode,o.value=n.payload.tmsPassword||n.payload.password,t.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("input",{bubbles:!0})),u.click(),e({ok:!0})})})();
