(function(){"use strict";const y=typeof self<"u"?self:window,a=y.browser??y.chrome;async function i(e,t){try{return await a.tabs.sendMessage(e,{action:t.action,payload:t.payload})}catch(n){console.error("Error sending message to content: ",n)}}function d(e,t){const n=(o,r,u)=>{if(typeof o=="object"&&o!==null&&o.action===e){const s=t(o,u);if(s instanceof Promise)return s.then(),!0}};return a.runtime.onMessage.addListener(n),()=>a.runtime.onMessage.removeListener(n)}async function T(e,t){var n;for(let o=0;o<50;o++){try{if((n=(await a.scripting.executeScript({target:{tabId:e},func:u=>u.every(s=>document.querySelector(s)!==null),args:[t]}))[0])!=null&&n.result)return}catch{}await new Promise(r=>setTimeout(r,100))}throw new Error("Elements not found")}async function l(e,t){t?await T(e,t):await new Promise(n=>{const o=r=>{r.tabId===e&&r.frameId===0&&(a.webNavigation.onCompleted.removeListener(o),n())};a.webNavigation.onCompleted.addListener(o)})}async function g(e){const t=await a.tabs.create({url:e});return await l(t.id),t}const p={SETTINGS:"settings"},N="https://neptun.elte.hu/Account/Login",S="https://canvas.elte.hu",f="https://tms.inf.elte.hu",w={NEPTUN_CODE_INPUT:"#LoginName",NEPTUN_PASSWORD_INPUT:"#Password",NEPTUN_LOGIN_SUBMIT:"input[type=submit]",TOTP_CODE_INPUT:"input[name=TOTPCode]",TOTP_LOGIN_SUBMIT:'button[type="submit"].btn.btn-primary',NEPTUN_SWEB_LINK:'a[href="/ToNeptunWeb/ToNeptunHWeb"]',LOGIN_WITH_NEPTUN_LINK:'a[href="/login/saml"]',IDP_CODE_INPUT:"#username_neptun",IDP_PASSWORD_INPUT:"#password_neptun",IDP_LOGIN_SUBMIT:"input[type=submit]",TMS_CODE_INPUT:'input[name="username"]',TMS_PASSWORD_INPUT:'input[name="password"]',TMS_LOGIN_BUTTON:'button[type="submit"]'};async function b(e){var t;try{return((t=(await a.scripting.executeScript({target:{tabId:e},func:()=>document.getElementById("layoutNavbarDropdownAccount")!==null}))[0])==null?void 0:t.result)===!0}catch(n){return console.warn("Error checking login status:",n),!1}}async function I(e){var t;try{return((t=(await a.scripting.executeScript({target:{tabId:e},func:()=>document.getElementById("global_nav_profile_link")!==null}))[0])==null?void 0:t.result)===!0}catch(n){return console.warn("Error checking login status:",n),!1}}async function _(e){var t;try{return((t=(await a.scripting.executeScript({target:{tabId:e},func:()=>document.querySelector('a[href="/settings"]')!==null}))[0])==null?void 0:t.result)===!0}catch(n){return console.warn("Error checking login status:",n),!1}}async function h(){const[e]=await a.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id))throw new Error("No active tab");return e}async function E(e){const[t]=await a.scripting.executeScript({target:{tabId:e},func:L});return t==null?void 0:t.result}function L(){document.documentElement.style.width="100vw",document.documentElement.style.overflowX="hidden",document.body.style.width="100vw",document.body.style.overflowX="hidden",document.querySelectorAll(".row").forEach(e=>e.style.display="inline"),document.querySelectorAll(".col-md-3, .col-md-4, .navbar, .content-title, .d-flex.justify-content-between.flex-wrap.flex-md-nowrap.align-items-center.pb-2.mb-2.border-primary").forEach(e=>e.remove()),document.querySelectorAll(".col-xl-10, .col-md-9").forEach(e=>e.style.maxWidth="97%")}function P(){return typeof browser<"u"&&browser.storage&&browser.storage.local?browser.storage.local:chrome.storage.local}async function O(){const e=P(),{[p.SETTINGS]:t}=await e.get(p.SETTINGS);if(!(t!==void 0)){const{autoLoginSettings:o}=await e.get("autoLoginSettings"),{language:r}=await e.get("language"),u=typeof r=="string"?r:"en",s=(o==null?void 0:o.credentials)||{},m=(o==null?void 0:o.neptun)||{},v={neptunCode:s.code||"",password:s.password||"",tmsPassword:s.tmspassword||"",otpSecret:s.otpSecret||"",autoStudentWeb:typeof m.studentWeb=="boolean"?m.studentWeb:!0,language:u};await e.set({[p.SETTINGS]:v}),await e.remove(["autoLoginSettings","language"])}}a.runtime.onInstalled.addListener(async e=>{if(e.reason==="update")try{await O()}catch(t){console.warn("Settings migration failed:",t)}});function c(e){if(!e)throw new Error("No response from content script");if(!e.ok)throw new Error(e.message)}d("neptunLogin",async e=>{try{const t=await g(N);if(await b(t.id)){if(e.payload.autoStudentWeb){const o=await i(t.id,{action:"studentWebClick",payload:null});c(o)}}else{const o=await i(t.id,{action:"neptunLogin",payload:e.payload});c(o),await l(t.id);const r=await i(t.id,{action:"neptunTOTP",payload:e.payload});if(c(r),e.payload.autoStudentWeb){await l(t.id);const u=await i(t.id,{action:"studentWebClick",payload:null});c(u)}}}catch(t){console.error("Error in neptunLogin handler:",t)}}),d("canvasLogin",async e=>{try{const t=await g(S);if(!await I(t.id)){const o=await i(t.id,{action:"loginWithNeptun",payload:null});c(o),await l(t.id);const r=await i(t.id,{action:"idpLogin",payload:e.payload});c(r)}}catch(t){console.error("Error in canvasLogin handler: ",t)}}),d("tmsLogin",async e=>{try{const t=await g(f);if(!await _(t.id)){await l(t.id,[w.TMS_CODE_INPUT,w.TMS_PASSWORD_INPUT,w.TMS_LOGIN_BUTTON]);const o=await i(t.id,{action:"tmsLogin",payload:e.payload});c(o)}}catch(t){console.error("Error in tmsLogin handler: ",t)}}),d("tmsFocus",async(e,t)=>{try{const n=await h();n.url&&n.url.startsWith(f)?(await E(n.id),t({ok:!0})):t({ok:!1})}catch(n){console.error("Error in tmsFocus handler: ",n)}})})();
